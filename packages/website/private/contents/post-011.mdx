---
slug: migration-to-vite-plugin-rsc
title: Waku's Migration to @vitejs/plugin-rsc
description: Technical details and breaking changes in Waku's migration to the official Vite React Server Components plugin.
author: hi-ogawa
release: v0.24
date: 2025/07/19
---

Waku has migrated to use Vite's official plugin [`@vitejs/plugin-rsc`](https://github.com/vitejs/vite-plugin-react/tree/main/packages/plugin-rsc) for React Server Components bundler implementation. This migration simplifies internal architecture and unlocks new capabilities through the [Vite Environment API](https://vite.dev/guide/api-environment.html).

Waku has pioneered RSC framework implementation on Vite and provided many insights for the official Vite plugin. Some core RSC functionalities have been incorporated into `@vitejs/plugin-rsc`, benefiting the entire Vite ecosystem.

While there were large changes in internal Vite development server, build pipeline and plugin architecture, core routing logic remains almost unchanged, preserving Waku's existing functionality. This is thanks to Waku's layered routing architecture where the higher level APIs (`fsRouter`, `createPages`, and `defineRouter`) are built up on the "minimal" API `defineEntries`.

## New features / Breaking Changes

### Custom Vite configuration

Custom Vite configuration support has changed. Vite configuration must now be nested under a `vite` property in `waku.config.ts`:

_Before_

```ts
// vite.config.ts
import { defineConfig } from "vite";

export default defineConfig({ ... })
```

```ts
// waku.config.ts
import { defineConfig } from "waku/config";

export default defineConfig({
  unstable_viteConfigs: { ... },
})
```

_After_

```ts
// waku.config.ts
import { defineConfig } from "waku/config";

export default defineConfig({
  vite: { ... }
})
```

_Example_

```ts
// waku.config.ts
import { defineConfig } from 'waku/config';

export default defineConfig({
  vite: {
    environments: {
      // environment-specific configurations.
      // `client`, `ssr`, and `rsc` environments are available.
      client: {
        build: {
          // enable source maps for client build
          sourcemap: true,
        },
      },
      ssr: {
        optimizeeDeps: {
          include: [
            // handle cjs package during SSR
          ],
        },
      },
      rsc: {
        // ...
      },
    },
    plugins: [
      // custom plugins
      {
        name: 'my-custom-plugin',
        transform(code, id) {
          // e.g. transform only on `rsc` environment
          if (this.environment.name === 'rsc') {
            // ...
          }
        },
      },
    ],
  },
});
```

### Transforming external packages

Previously `ssr` environment "main server") doesn't externalize server deps by default, but transform all react deps. This means if there's cjs dependency (directly or transitively) used in client component, SSR might fail during dev. For example, `swr` (esm) package uses `use-sync-external-store` (cjs) internally. This can be mitigated by `environments.ssr.optimizeDeps.include: ["swr"]`.

## Previous Implementation

The previous implementation remains available via the `--experimental-legacy-cli` flag for fallback during the transition period, for example,

```bash
waku dev --experimental-legacy-cli
waku build --experimental-legacy-cli
waku start --experimental-legacy-cli
```

This flag allows reverting to the previous behavior while the new implementation is refined based on usage feedback.

## Future

- `@cloudflare/vite-plugin`
- Nitro plugin?
- Better alignment with Vite ecosystem.
- Rolldown-Vite support.
